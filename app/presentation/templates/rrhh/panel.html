{% extends 'layouts/dashboard.html' %} 
{% block title %}Panel RRHH{% endblock %}
{% block dashboard_content %}

<!-- Encabezado mejorado -->
<div class="mb-4 pb-3 border-bottom">
   <h1 class="h2 mb-1">Panel de Recursos Humanos</h1>
   <p class="text-muted mb-0">
      <i class="bi bi-person-circle me-2"></i>Bienvenido, <strong>{{ current_user.username }}</strong>
   </p>
</div>

<!-- GRÁFICO 1: Distribución por Unidad Administrativa -->
<div class="row g-4">
   <div class="col-lg-8">
      <div class="card h-100 border-0 shadow-sm">
         <div class="card-header bg-white border-0 py-3">
            <div class="d-flex align-items-center">
               <div class="icon-box me-3">
                  <i class="bi bi-building text-primary"></i>
               </div>
               <div>
                  <h5 class="card-title mb-1">Distribución por Unidad Administrativa</h5>
                  <p class="text-muted small mb-0">Visualización del personal por departamento</p>
               </div>
            </div>
         </div>
         <div class="card-body">
            <canvas id="empleadosUnidadChart" height="200"></canvas>
         </div>
      </div>
   </div>
   
   <div class="col-lg-4">
      <div class="card h-100 border-0 shadow-sm">
         <div class="card-header bg-white border-0 py-3">
            <h5 class="card-title mb-0">
               <i class="bi bi-pie-chart me-2 text-primary"></i>Resumen General
            </h5>
         </div>
         <div class="card-body">
            <div class="stat-card mb-3 p-3 bg-light rounded">
               <div class="d-flex justify-content-between align-items-center">
                  <div>
                     <small class="text-muted d-block">Total de Empleados</small>
                     <h3 class="mb-0 text-primary">{{ empleados_unidad | sum(attribute='cantidad') }}</h3>
                  </div>
                  <div class="stat-icon">
                     <i class="bi bi-people-fill text-primary"></i>
                  </div>
               </div>
            </div>
            
            <div class="stat-card mb-3 p-3 bg-light rounded">
               <div class="d-flex justify-content-between align-items-center">
                  <div>
                     <small class="text-muted d-block">Unidades Activas</small>
                     <h3 class="mb-0 text-success">{{ empleados_unidad | length }}</h3>
                  </div>
                  <div class="stat-icon">
                     <i class="bi bi-diagram-3-fill text-success"></i>
                  </div>
               </div>
            </div>
            
            <hr class="my-3" />
            
            <h6 class="mb-3 text-muted">
               <i class="bi bi-list-ul me-2"></i>Detalle por Unidad
            </h6>
            <div class="list-container" style="max-height: 280px; overflow-y: auto">
               {% for unidad in empleados_unidad %}
               <div class="list-item d-flex justify-content-between align-items-center py-2 px-2 mb-2 rounded hover-effect">
                  <span class="small fw-medium">
                     <i class="bi bi-dot text-primary"></i>{{ unidad.nombre_unidad }}
                  </span>
                  <span class="badge rounded-pill bg-primary">{{ unidad.cantidad }}</span>
               </div>
               {% endfor %}
            </div>
         </div>
      </div>
   </div>
</div>

<!-- GRÁFICO 2: Distribución por Estado -->
<div class="row g-4 mt-2">
   <div class="col-lg-8">
      <div class="card h-100 border-0 shadow-sm">
         <div class="card-header bg-white border-0 py-3">
            <div class="d-flex align-items-center">
               <div class="icon-box me-3">
                  <i class="bi bi-toggle-on text-success"></i>
               </div>
               <div>
                  <h5 class="card-title mb-1">Estado de Empleados</h5>
                  <p class="text-muted small mb-0">Distribución entre personal activo e inactivo</p>
               </div>
            </div>
         </div>
         <div class="card-body">
            <canvas id="chartEstado" height="200"></canvas>
         </div>
      </div>
   </div>
   
   <div class="col-lg-4">
      <div class="card h-100 border-0 shadow-sm">
         <div class="card-header bg-white border-0 py-3">
            <h5 class="card-title mb-0">
               <i class="bi bi-clipboard-data me-2 text-success"></i>Resumen de Estados
            </h5>
         </div>
         <div class="card-body">
            <div class="stat-card mb-3 p-3 bg-light rounded">
               <div class="d-flex justify-content-between align-items-center">
                  <div>
                     <small class="text-muted d-block">Total Registrado</small>
                     <h3 class="mb-0 text-info">{{ empleados_estado | sum(attribute='cantidad') }}</h3>
                  </div>
                  <div class="stat-icon">
                     <i class="bi bi-person-check-fill text-info"></i>
                  </div>
               </div>
            </div>
            
            <div class="stat-card mb-3 p-3 bg-light rounded">
               <div class="d-flex justify-content-between align-items-center">
                  <div>
                     <small class="text-muted d-block">Tipos de Estado</small>
                     <h3 class="mb-0 text-warning">{{ empleados_estado | length }}</h3>
                  </div>
                  <div class="stat-icon">
                     <i class="bi bi-tags-fill text-warning"></i>
                  </div>
               </div>
            </div>
            
            <hr class="my-3" />
            
            <h6 class="mb-3 text-muted">
               <i class="bi bi-list-check me-2"></i>Detalle por Estado
            </h6>
            <div class="list-container" style="max-height: 280px; overflow-y: auto">
               {% for estado in empleados_estado %}
               <div class="list-item d-flex justify-content-between align-items-center py-2 px-3 mb-2 rounded hover-effect"
                    style="border-left: 3px solid {{ '#4BC0C0' if estado.estado == 'Activos' else '#FF6384' }}">
                  <span class="small fw-medium">
                     <i class="bi {{ 'bi-check-circle-fill' if estado.estado == 'Activos' else 'bi-x-circle-fill' }} me-2"
                        style="color: {{ '#4BC0C0' if estado.estado == 'Activos' else '#FF6384' }}"></i>
                     {{ estado.estado }}
                  </span>
                  <span class="badge rounded-pill {{ 'bg-success' if estado.estado == 'Activos' else 'bg-secondary' }}">
                     {{ estado.cantidad }}
                  </span>
               </div>
               {% endfor %}
            </div>
         </div>
      </div>
   </div>
</div>

<!-- GRÁFICO 3: Distribución por Sexo -->
<div class="row g-4 mt-2 mb-4">
   <div class="col-lg-8">
      <div class="card h-100 border-0 shadow-sm">
         <div class="card-header bg-white border-0 py-3">
            <div class="d-flex align-items-center">
               <div class="icon-box me-3">
                  <i class="bi bi-gender-ambiguous text-info"></i>
               </div>
               <div>
                  <h5 class="card-title mb-1">Distribución por Género</h5>
                  <p class="text-muted small mb-0">Composición demográfica del personal</p>
               </div>
            </div>
         </div>
         <div class="card-body">
            <canvas id="chartSexo" height="200"></canvas>
         </div>
      </div>
   </div>
   
   <div class="col-lg-4">
      <div class="card h-100 border-0 shadow-sm">
         <div class="card-header bg-white border-0 py-3">
            <h5 class="card-title mb-0">
               <i class="bi bi-bar-chart me-2 text-info"></i>Resumen de Género
            </h5>
         </div>
         <div class="card-body">
            <div class="stat-card mb-3 p-3 bg-light rounded">
               <div class="d-flex justify-content-between align-items-center">
                  <div>
                     <small class="text-muted d-block">Total de Empleados</small>
                     <h3 class="mb-0 text-info">{{ empleados_sexo | sum(attribute='cantidad') }}</h3>
                  </div>
                  <div class="stat-icon">
                     <i class="bi bi-people text-info"></i>
                  </div>
               </div>
            </div>
            
            <div class="stat-card mb-3 p-3 bg-light rounded">
               <div class="d-flex justify-content-between align-items-center">
                  <div>
                     <small class="text-muted d-block">Géneros Registrados</small>
                     <h3 class="mb-0 text-warning">{{ empleados_sexo | length }}</h3>
                  </div>
                  <div class="stat-icon">
                     <i class="bi bi-collection-fill text-warning"></i>
                  </div>
               </div>
            </div>
            
            <hr class="my-3" />
            
            <h6 class="mb-3 text-muted">
               <i class="bi bi-graph-up me-2"></i>Detalle de Distribución
            </h6>
            <div class="list-container" style="max-height: 280px; overflow-y: auto">
               {% for sexo in empleados_sexo %}
               <div class="list-item d-flex justify-content-between align-items-center py-2 px-2 mb-2 rounded hover-effect">
                  <span class="small fw-medium">
                     <i class="bi bi-circle-fill me-2" style="font-size: 8px; color: {{ '#36A2EB' if loop.index == 1 else ('#FF6384' if loop.index == 2 else '#FFCE56') }}"></i>
                     {{ sexo.sexo }}
                  </span>
                  <span class="badge rounded-pill bg-secondary">{{ sexo.cantidad }}</span>
               </div>
               {% endfor %}
            </div>
         </div>
      </div>
   </div>
</div>

<!-- Scripts de Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script nonce="{{ csp_nonce() }}">
   document.addEventListener('DOMContentLoaded', function() {
       // Configuración común para todos los gráficos
       Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
       
       // GRÁFICO 1: Unidad Administrativa (Doughnut mejorado)
       const labelsUnidad = {{ empleados_unidad | map(attribute='nombre_unidad') | list | tojson | safe }};
       const dataValuesUnidad = {{ empleados_unidad | map(attribute='cantidad') | list | tojson | safe }};

       const ctxUnidad = document.getElementById('empleadosUnidadChart').getContext('2d');
       new Chart(ctxUnidad, {
           type: 'doughnut',
           data: {
               labels: labelsUnidad,
               datasets: [{
                   data: dataValuesUnidad,
                   backgroundColor: [
                       '#FF6384', '#36A2EB', '#FFCE56', 
                       '#4BC0C0', '#9966FF', '#FF9F40',
                       '#FF6B9D', '#4ECDC4', '#45B7D1'
                   ],
                   borderColor: '#ffffff',
                   borderWidth: 3,
                   hoverOffset: 8
               }]
           },
           options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                   legend: { 
                       position: 'bottom',
                       labels: {
                           padding: 15,
                           usePointStyle: true,
                           font: { size: 12 }
                       }
                   },
                   tooltip: {
                       backgroundColor: 'rgba(0,0,0,0.8)',
                       padding: 12,
                       cornerRadius: 8,
                       callbacks: {
                           label: function(context) {
                               const total = context.dataset.data.reduce((a, b) => a + b, 0);
                               const value = context.parsed;
                               const percentage = ((value / total) * 100).toFixed(1);
                               return ` ${context.label}: ${value} empleados (${percentage}%)`;
                           }
                       }
                   }
               },
               cutout: '65%'
           }
       });

       // GRÁFICO 2: Estado (Pie mejorado)
       const estadoData = {{ empleados_estado | tojson | safe }};
       const labelsEstado = estadoData.map(item => item.estado);
       const valuesEstado = estadoData.map(item => item.cantidad);

       const ctxEstado = document.getElementById('chartEstado').getContext('2d');
       new Chart(ctxEstado, {
           type: 'pie',
           data: {
               labels: labelsEstado,
               datasets: [{
                   data: valuesEstado,
                   backgroundColor: ['#4BC0C0', '#FF6384'],
                   borderColor: '#ffffff',
                   borderWidth: 4,
                   hoverOffset: 10
               }]
           },
           options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                   legend: { 
                       position: 'right',
                       labels: {
                           padding: 20,
                           usePointStyle: true,
                           font: { size: 13 }
                       }
                   },
                   tooltip: {
                       backgroundColor: 'rgba(0,0,0,0.8)',
                       padding: 12,
                       cornerRadius: 8,
                       callbacks: {
                           label: function(context) {
                               const total = context.dataset.data.reduce((a, b) => a + b, 0);
                               const value = context.parsed;
                               const percentage = ((value / total) * 100).toFixed(1);
                               return ` ${context.label}: ${value} (${percentage}%)`;
                           }
                       }
                   }
               }
           }
       });

       // GRÁFICO 3: Sexo (Bar mejorado)
       const sexoData = {{ empleados_sexo | tojson | safe }};
       const labelsSexo = sexoData.map(item => item.sexo);
       const valuesSexo = sexoData.map(item => item.cantidad);

       const ctxSexo = document.getElementById('chartSexo').getContext('2d');
       new Chart(ctxSexo, {
           type: 'bar',
           data: {
               labels: labelsSexo,
               datasets: [{
                   label: 'Cantidad de empleados',
                   data: valuesSexo,
                   backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56'],
                   borderColor: ['#2E8BC0', '#E54A6B', '#FFB732'],
                   borderWidth: 2,
                   borderRadius: 8,
                   hoverBackgroundColor: ['#2E8BC0', '#E54A6B', '#FFB732']
               }]
           },
           options: {
               responsive: true,
               maintainAspectRatio: false,
               scales: {
                   y: { 
                       beginAtZero: true,
                       grid: {
                           color: 'rgba(0,0,0,0.05)'
                       },
                       ticks: {
                           font: { size: 12 }
                       }
                   },
                   x: {
                       grid: {
                           display: false
                       },
                       ticks: {
                           font: { size: 12 }
                       }
                   }
               },
               plugins: {
                   legend: { display: false },
                   tooltip: {
                       backgroundColor: 'rgba(0,0,0,0.8)',
                       padding: 12,
                       cornerRadius: 8
                   }
               }
           }
       });
   });
</script>

<style>
   /* Estilos mejorados para el dashboard */
   .card {
      border-radius: 12px;
   }
   
   .card-header {
      border-radius: 12px 12px 0 0 !important;
   }
   
   .icon-box {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      font-size: 24px;
      color: white;
      box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
   }
   
   .icon-box i {
      color: white !important;
   }
   
   .stat-card {
      border: 1px solid transparent;
   }
   
   .stat-icon i {
      font-size: 32px;
      opacity: 0.3;
   }
   
   .list-container {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e0 #f7fafc;
   }
   
   .list-container::-webkit-scrollbar {
      width: 6px;
   }
   
   .list-container::-webkit-scrollbar-track {
      background: #f7fafc;
      border-radius: 10px;
   }
   
   .list-container::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 10px;
   }
   
   .list-container::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
   }
   
   .list-item {
      background-color: #f8f9fa;
   }
   
   .list-item:hover {
      background-color: #e9ecef;
   }
   
   .badge {
      font-weight: 500;
      padding: 0.35em 0.65em;
   }
   
   .border-bottom {
      border-color: #e9ecef !important;
   }
   
   h3 {
      font-weight: 700;
   }
   
   .small {
      font-size: 0.875rem;
   }
</style>
{% endblock %}