{% extends 'layouts/dashboard.html' %}

{% block title %}{{ titulo }}{% endblock %}
{% block page_title %}{{ titulo }}{% endblock %}

{% block dashboard_content %}
<div style="max-width: 900px; margin: 0 auto;">
    <!-- BREADCRUMB -->
    <ul class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('legajo.listar_personal') }}">Personal</a></li>
        <li class="breadcrumb-item active">Cargar PDF</li>
    </ul>
    
    <!-- ENCABEZADO -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 style="margin: 0; font-size: 2rem; font-weight: 700; color: #1e3a8a;">
                <i class="bi bi-file-pdf-fill me-2"></i>{{ titulo }}
            </h1>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280;">Carga un PDF para organizar automáticamente los documentos del legajo</p>
        </div>
        <a href="{{ url_for('legajo.listar_personal') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>
    
    <!-- ALERTAS DE ERROR - Placeholder para mensajes de validación -->
    <div id="alertaError" class="alert alert-danger" role="alert" style="display: none;">
        <i class="bi bi-exclamation-circle-fill"></i>
        <div>
            <strong>Por favor corrige los siguientes errores:</strong>
            <div id="listaErrores" style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;"></div>
        </div>
    </div>

    <!-- ALERTAS DE SESIÓN -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    <i class="bi bi-{{ 'exclamation-circle-fill' if category == 'error' else 'check-circle-fill' }}"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- FORMULARIO PRINCIPAL -->
    <form method="POST" enctype="multipart/form-data" novalidate id="uploadForm">
        
        <!-- CARD: SELECCIONAR PERSONAL -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-person-fill"></i> Seleccionar Personal
            </div>
            <div class="card-body">
                <!-- Búsqueda/Filtro -->
                <div class="mb-3" id="busquedaContainer">
                    <label for="buscarPersonal" class="form-label">Buscar Personal <span class="text-muted">(por DNI o Nombre)</span></label>
                    <input type="text" class="form-control" id="buscarPersonal" placeholder="Ej: 12345678 o Juan Pérez" onkeyup="filtrarPersonal()">
                    <div class="form-text">
                        <i class="bi bi-info-circle"></i> Escribe el DNI o nombre para filtrar
                    </div>
                </div>

                <!-- Selector -->
                <div class="mb-3">
                    <label for="id_personal" class="form-label">Personal <span class="text-danger">*</span></label>
                    <select class="form-select" id="id_personal" name="id_personal" required>
                        <option value="">-- Seleccione un Personal --</option>
                    </select>
                    <div class="invalid-feedback">Por favor selecciona un personal.</div>
                </div>

                <!-- Mensaje si viene preseleccionado -->
                {% if personal_preseleccionado %}
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i>
                    <strong>Personal preseleccionado:</strong> {{ personal_preseleccionado.nombre }} ({{ personal_preseleccionado.dni }})
                    <br/>
                    <small>Si deseas seleccionar otro personal, utiliza el buscador arriba.</small>
                </div>
                <script nonce="{{ csp_nonce() }}">
                // Pasar el ID del personal preseleccionado al JavaScript
                window.idPersonalPreseleccionado = {{ personal_preseleccionado.id }};
                </script>
                {% endif %}

                <!-- INFO DEL PERSONAL SELECCIONADO -->
                <div id="personalInfo" style="display: none;">
                    <div class="alert alert-info" role="alert">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Nombre:</strong> <span id="personalNombre">-</span><br>
                                <strong>DNI:</strong> <span id="personalDNI">-</span>
                            </div>
                            <div class="col-md-6">
                                <strong>Unidad:</strong> <span id="personalUnidad">-</span><br>
                                <strong>Cargo:</strong> <span id="personalCargo">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD: ESTRUCTURA DEL LEGAJO -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-diagram-3"></i> Estructura del Legajo
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">El PDF será dividido según la siguiente estructura personalizada:</p>
                <div id="estructuraContainer" class="table-responsive" style="display: none;">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Sección</th>
                                <th>Páginas</th>
                            </tr>
                        </thead>
                        <tbody id="estructuraTable">
                            <!-- Rellenado por JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="noEstructura" class="alert alert-warning">
                    <i class="bi bi-info-circle"></i> Selecciona un personal para ver la estructura del legajo
                </div>
            </div>
        </div>

        <!-- CARD: SUBIR ARCHIVO -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-file-earmark-pdf"></i> Archivo PDF
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="archivo_pdf" class="form-label">Selecciona un archivo PDF <span class="text-danger">*</span></label>
                    <input type="file" class="form-control" id="archivo_pdf" name="archivo_pdf" accept=".pdf" required>
                    <div class="form-text">
                        <i class="bi bi-info-circle"></i> Solo se aceptan archivos PDF. Máximo 50 MB.
                    </div>
                    <div class="invalid-feedback">Por favor selecciona un archivo PDF válido.</div>
                </div>
            </div>
        </div>

        <!-- BOTONES DE ACCIÓN -->
        <div class="d-flex gap-2 justify-content-end mb-4">
            <a href="{{ url_for('legajo.listar_personal') }}" class="btn btn-secondary">
                <i class="bi bi-x-lg"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="bi bi-upload"></i> Cargar PDF
            </button>
        </div>

    </form>

</div>

<!-- Script externo para upload de legajo -->
<script src="{{ url_for('static', filename='js/upload-legajo-handlers.js') }}"></script>
<script src="{{ url_for('static', filename='js/upload_legajo.js') }}"></script>

<style>
.breadcrumb {
    background-color: transparent;
    padding: 0;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #1e3a8a;
}

.card {
    border-left: 4px solid #1e3a8a;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.table-light {
    background-color: #f8f9fa;
}

.form-label {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.5rem;
}

.text-danger {
    color: #dc2626;
}
</style>
{% endblock %}
