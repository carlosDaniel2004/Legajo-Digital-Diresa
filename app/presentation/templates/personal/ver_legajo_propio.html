{% extends "personal/dashboard.html" %}

{% block title %}Mi Legajo Digital{% endblock %}

{# CORRECCIÓN: Herencia correcta para mantener sidebar activo #}
{% block content %}
<div class="container-fluid">

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Mi Legajo Digital</h1>
        <a href="{{ url_for('personal.inicio') }}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50"></i> Volver
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show shadow-sm" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="card shadow mb-4">
        <div class="card-header py-3 border-bottom-primary">
            <h6 class="m-0 font-weight-bold text-primary">Ficha de Datos Personales</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-2 text-center mb-3">
                    <div class="rounded-circle bg-gray-200 d-flex align-items-center justify-content-center mx-auto" style="width: 100px; height: 100px;">
                        <i class="fas fa-user fa-3x text-gray-400"></i>
                    </div>
                </div>
                <div class="col-md-10">
                    <div class="row">
                        <div class="col-md-4">
                            <h5 class="font-weight-bold">{{ legajo.personal.nombres }} {{ legajo.personal.apellidos }}</h5>
                            <p class="mb-1"><i class="fas fa-id-card mr-2 text-gray-400"></i> DNI: <strong>{{ legajo.personal.dni }}</strong></p>
                            <p class="mb-1"><i class="fas fa-venus-mars mr-2 text-gray-400"></i> Sexo: {{ legajo.personal.sexo }}</p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1"><i class="fas fa-building mr-2 text-gray-400"></i> Unidad: {{ legajo.personal.unidad }}</p>
                            <p class="mb-1"><i class="fas fa-envelope mr-2 text-gray-400"></i> Email: {{ legajo.personal.email }}</p>
                            <p class="mb-1"><i class="fas fa-phone mr-2 text-gray-400"></i> Teléfono: {{ legajo.personal.telefono }}</p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1"><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i> Dirección: {{ legajo.personal.direccion }}</p>
                            <p class="mb-1"><i class="fas fa-birthday-cake mr-2 text-gray-400"></i> Fecha Nac.: {{ legajo.personal.fecha_nacimiento }}</p>
                            <p class="mb-1"><i class="fas fa-info-circle mr-2 text-gray-400"></i> Estado Civil: {{ legajo.personal.estado_civil }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header p-0">
            <ul class="nav nav-tabs" id="legajoTab" role="tablist" style="background-color: #f8f9fc;">
                <li class="nav-item"><a class="nav-link active" id="docs-tab" data-toggle="tab" href="#documentos" role="tab">Documentos</a></li>
                <li class="nav-item"><a class="nav-link" id="contratos-tab" data-toggle="tab" href="#contratos" role="tab">Contratos</a></li>
                <li class="nav-item"><a class="nav-link" id="estudios-tab" data-toggle="tab" href="#estudios" role="tab">Estudios</a></li>
                <li class="nav-item"><a class="nav-link" id="capacitacion-tab" data-toggle="tab" href="#capacitaciones" role="tab">Capacitaciones</a></li>
                <li class="nav-item"><a class="nav-link" id="historial-tab" data-toggle="tab" href="#historial" role="tab">Historial</a></li>
                <li class="nav-item"><a class="nav-link" id="licencias-tab" data-toggle="tab" href="#licencias" role="tab">Licencias</a></li>
            </ul>
        </div>
        
        <div class="card-body">
            <div class="tab-content" id="legajoTabContent">
                
                <div class="tab-pane fade show active" id="documentos" role="tabpanel">
                    {% if legajo.documentos %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="thead-light">
                                <tr>
                                    <th>Tipo</th>
                                    <th>Sección</th>
                                    <th>Nombre Archivo</th>
                                    <th>Fecha</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in legajo.documentos %}
                                <tr>
                                    <td><span class="badge badge-primary">{{ doc.nombre_tipo }}</span></td>
                                    <td>{{ doc.nombre_seccion }}</td>
                                    <td>{{ doc.nombre_archivo }}</td>
                                    <td>{{ doc.fecha_subida }}</td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('legajo.ver_documento', documento_id=doc.id_documento) }}" target="_blank" class="btn btn-info btn-sm" title="Ver">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('legajo.ver_documento', documento_id=doc.id_documento) }}?download=1" class="btn btn-success btn-sm" title="Descargar">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <a href="{{ url_for('personal.solicitar_cambio_documento', documento_id=doc.id_documento) }}" class="btn btn-warning btn-sm text-white" title="Solicitar Cambio / Corrección">
                                                <i class="fas fa-sync-alt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-light text-center">No hay documentos.</div>
                    {% endif %}
                </div>

                <div class="tab-pane fade" id="contratos" role="tabpanel">
                    {% if legajo.contratos %}
                    <table class="table table-bordered">
                        <thead class="thead-light"><tr><th>Tipo</th><th>Modalidad</th><th>Inicio</th><th>Fin</th><th>Sueldo</th><th>Res.</th></tr></thead>
                        <tbody>
                            {% for c in legajo.contratos %}
                            <tr><td>{{ c.tipo_contrato_nombre }}</td><td>{{ c.modalidad }}</td><td>{{ c.fecha_inicio }}</td><td>{{ c.fecha_fin or 'Indet.' }}</td><td>{{ c.sueldo }}</td><td>{{ c.resolucion }}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}<p class="text-center text-muted p-3">Sin registros.</p>{% endif %}
                </div>

                <div class="tab-pane fade" id="estudios" role="tabpanel">
                     {% if legajo.estudios %}
                    <table class="table table-bordered">
                        <thead class="thead-light"><tr><th>Nivel</th><th>Institución</th><th>Título</th><th>Fechas</th></tr></thead>
                        <tbody>
                            {% for e in legajo.estudios %}
                            <tr><td>{{ e.nivel_educativo }}</td><td>{{ e.institucion }}</td><td>{{ e.carrera or e.titulo_obtenido }}</td><td>{{ e.fecha_inicio }} - {{ e.fecha_fin }}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}<p class="text-center text-muted p-3">Sin registros.</p>{% endif %}
                </div>

                <div class="tab-pane fade" id="capacitaciones" role="tabpanel">
                     {% if legajo.capacitaciones %}
                    <table class="table table-bordered">
                        <thead class="thead-light"><tr><th>Evento</th><th>Organizador</th><th>Fechas</th><th>Horas</th></tr></thead>
                        <tbody>
                            {% for cap in legajo.capacitaciones %}
                            <tr><td>{{ cap.nombre_evento }}</td><td>{{ cap.organizador }}</td><td>{{ cap.fecha_inicio }} al {{ cap.fecha_fin }}</td><td>{{ cap.duracion_horas }}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}<p class="text-center text-muted p-3">Sin registros.</p>{% endif %}
                </div>

                <div class="tab-pane fade" id="historial" role="tabpanel">
                     {% if legajo.historial %}
                    <table class="table table-bordered">
                        <thead class="thead-light"><tr><th>Unidad</th><th>Cargo</th><th>Inicio</th><th>Fin</th><th>Motivo</th></tr></thead>
                        <tbody>
                            {% for h in legajo.historial %}
                            <tr><td>{{ h.unidad_administrativa_nombre }}</td><td>{{ h.nombre_cargo }}</td><td>{{ h.fecha_inicio }}</td><td>{{ h.fecha_fin or 'Actual' }}</td><td>{{ h.motivo_salida }}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}<p class="text-center text-muted p-3">Sin registros.</p>{% endif %}
                </div>

                <div class="tab-pane fade" id="licencias" role="tabpanel">
                     {% if legajo.licencias %}
                    <table class="table table-bordered">
                        <thead class="thead-light"><tr><th>Tipo</th><th>Inicio</th><th>Fin</th><th>Resolución</th></tr></thead>
                        <tbody>
                            {% for l in legajo.licencias %}
                            <tr><td>{{ l.tipo_licencia_nombre }}</td><td>{{ l.fecha_inicio }}</td><td>{{ l.fecha_fin }}</td><td>{{ l.resolucion }}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}<p class="text-center text-muted p-3">Sin registros.</p>{% endif %}
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}